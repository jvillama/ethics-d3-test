<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <style>
      .control-group {
        display: flex;
        justify-content: space-between;
        padding-bottom: 10px;
      }

      path {
        fill: #ccc;
        stroke: grey;
        stroke-linejoin: round;
      }

      .tooltip {
        position: absolute;
        width: auto;
        height: auto;
        padding: 4px;
        padding-top: 8px;
        font: 12px sans-serif;
        color: white;
        /* text-align: center; */
        background: #fe8300;
        border: 0;
        border-radius: 10px;
        opacity: 0;
      }
    </style>
  </head>

  <body>
    <b>Filter(s):</b>
    <div class="control-group">
      <div class="select">
        <label for="selCand">Candidate:</label>
        <select class="bk bk-input" name="selCand" id="selCand" onchange="candOptionChanged(this.value)" autocomplete="off">
          <option class="bk" selected="true" value="All">All</option>
          <option class="bk" value="Aldana, Manuel">Aldana, Manuel</option>
          <option class="bk" value="Alva, Lisa">Alva, Lisa</option>
          <option class="bk" value="Amori, Paul">Amori, Paul</option>
          <option class="bk" value="Arnold, Caney">Arnold, Caney</option>
          <option class="bk" value="Ayala, Olga">Ayala, Olga</option>
          <option class="bk" value="BARR, STEVE">BARR, STEVE</option>
          <option class="bk" value="Barton, Luca ">Barton, Luca </option>
          <option class="bk" value="Bernal, Benny ">Bernal, Benny </option>
          <option class="bk" value="Blumenfield, Bob">Blumenfield, Bob</option>
          <option class="bk" value="Bonin, Mike">Bonin, Mike</option>
          <option class="bk" value="Bray-Ali, Josef A.">Bray-Ali, Josef A.</option>
          <option class="bk" value="Buscaino, Joe">Buscaino, Joe</option>
          <option class="bk" value="CHASE, NICOLE">CHASE, NICOLE</option>
          <option class="bk" value="Cabrera, Adriana">Cabrera, Adriana</option>
          <option class="bk" value="Cedillo, Gil">Cedillo, Gil</option>
          <option class="bk" value="Creed, Jesse M.">Creed, Jesse M.</option>
          <option class="bk" value="De la Torre, David">De la Torre, David</option>
          <option class="bk" value="Feuer, Mike">Feuer, Mike</option>
          <option class="bk" value="Flores, Fred ">Flores, Fred </option>
          <option class="bk" value="GALPERIN, RON">GALPERIN, RON</option>
          <option class="bk" value="Garcetti, Eric">Garcetti, Eric</option>
          <option class="bk" value="Garcia, Monica">Garcia, Monica</option>
          <option class="bk" value="Giaba, Matthew">Giaba, Matthew</option>
          <option class="bk" value="Gibson, Robert">Gibson, Robert</option>
          <option class="bk" value="Gomes, Terrence">Gomes, Terrence</option>
          <option class="bk" value="Gonez, Kelly">Gonez, Kelly</option>
          <option class="bk" value="Gould, Noel">Gould, Noel</option>
          <option class="bk" value="Hernandez, David">Hernandez, David</option>
          <option class="bk" value="Hernandez, Giovany">Hernandez, Giovany</option>
          <option class="bk" value="Higginson , John ">Higginson , John
          </option>
          <option class="bk" value="Holdorff Polhill, Allison">Holdorff Polhill, Allison</option>
          <option class="bk" value="Koretz, Paul">Koretz, Paul</option>
          <option class="bk" value="Kremer, Yuval">Kremer, Yuval</option>
          <option class="bk" value="Markland, Montgomery ">Markland, Montgomery
          </option>
          <option class="bk" value="Martayan, Gregory ">Martayan, Gregory
          </option>
          <option class="bk" value="Martinez, Venessa">Martinez, Venessa</option>
          <option class="bk" value="Melvoin, Nicholas">Melvoin, Nicholas</option>
          <option class="bk" value="Miner, Arthur">Miner, Arthur</option>
          <option class="bk" value="Nuno , Jorge ">Nuno , Jorge </option>
          <option class="bk" value="O'Farrell, Mitch">O'Farrell, Mitch</option>
          <option class="bk" value="PARSEGHIAN, ARAZ">PARSEGHIAN, ARAZ</option>
          <option class="bk" value="Padilla, Imelda">Padilla, Imelda</option>
          <option class="bk" value="Petersen, Carl">Petersen, Carl</option>
          <option class="bk" value="Preven, Eric">Preven, Eric</option>
          <option class="bk" value="Price, Curren">Price, Curren</option>
          <option class="bk" value="RATLIFF, MONICA">RATLIFF, MONICA</option>
          <option class="bk" value="RYAVEC, MARK">RYAVEC, MARK</option>
          <option class="bk" value="Rodriguez, Monica">Rodriguez, Monica</option>
          <option class="bk" value="Rudisill, Robin ">Rudisill, Robin </option>
          <option class="bk" value="Salans, Jessica">Salans, Jessica</option>
          <option class="bk" value="Saunders, Constance">Saunders, Constance</option>
          <option class="bk" value="Schwartz, Mitchell">Schwartz, Mitchell</option>
          <option class="bk" value="Shain, Sylvie">Shain, Sylvie</option>
          <option class="bk" value="Sharp, Jeffery">Sharp, Jeffery</option>
          <option class="bk" value="Torossian, Karo">Torossian, Karo</option>
          <option class="bk" value="Woodruff, Nancy">Woodruff, Nancy</option>
          <option class="bk" value="ZIMMER, STEVE">ZIMMER, STEVE</option>
          <option class="bk" value="Zide, Bill">Zide, Bill</option>
        </select>
      </div>
      <div class="select">
        <label for="selPeriod">Filing Period:</label>
        <select class="bk bk-input" name="selPeriod" id="selPeriod" onchange="fileOptionChanged(this.value)"
          autocomplete="off">
          <option class="bk" selected="true" value="All">All</option>
          <option class="bk" value="1st Semi-Annual (2015-01-01 to 2015-06-30)">1st Semi-Annual (2015-01-01 to 2015-06-30)
          </option>
          <option class="bk" value="2nd Semi-Annual (2015-07-01 to 2015-12-31)">2nd Semi-Annual (2015-07-01 to 2015-12-31)
          </option>
          <option class="bk" value="1st Semi-Annual (2016-01-01 to 2016-06-30)">1st Semi-Annual (2016-01-01 to 2016-06-30)
          </option>
          <option class="bk" value="3rd Quarterly (2016-07-01 to 2016-09-30)">3rd Quarterly (2016-07-01 to 2016-09-30)
          </option>
          <option class="bk" value="4th Quarterly (2016-10-01 to 2016-12-31)">4th Quarterly (2016-10-01 to 2016-12-31)
          </option>
          <option class="bk" value="1st Pre-Election (2017-01-01 to 2017-01-21)">1st Pre-Election (2017-01-01 to 2017-01-21)
          </option>
          <option class="bk" value="2nd Pre-Election (2017-01-22 to 2017-02-18)">2nd Pre-Election (2017-01-22 to 2017-02-18)
          </option>
          <option class="bk" value="3rd Pre-Election (2017-02-19 to 2017-03-01)">3rd Pre-Election (2017-02-19 to 2017-03-01)
          </option>
          <option class="bk" value="1st Semi-Annual (2017-01-01 to 2017-06-30)">1st Semi-Annual (2017-01-01 to 2017-06-30)
          </option>
          <option class="bk" value="2nd Semi-Annual (2017-07-01 to 2017-12-31)">2nd Semi-Annual (2017-07-01 to 2017-12-31)
          </option>
          <option class="bk" value="1st Pre-Runoff (2017-03-02 to 2017-04-01)">1st Pre-Runoff (2017-03-02 to 2017-04-01)
          </option>
          <option class="bk" value="2nd Pre-Runoff (2017-04-02 to 2017-04-29)">2nd Pre-Runoff (2017-04-02 to 2017-04-29)
          </option>
          <option class="bk" value="3rd Pre-Runoff (2017-04-30 to 2017-05-10)">3rd Pre-Runoff (2017-04-30 to 2017-05-10)
          </option>
          <option class="bk" value="1st Semi-Annual (2018-01-01 to 2018-06-30)">1st Semi-Annual (2018-01-01 to 2018-06-30)
          </option>
          <option class="bk" value="2nd Semi-Annual (2018-07-01 to 2018-12-31)">2nd Semi-Annual (2018-07-01 to 2018-12-31)
          </option>
        </select>
      </div>
      <div class="select">
        <label for="selOffice">Office Seat:</label>
        <select class="bk bk-input" name="selOffice" id="selOffice" onchange="officeOptionChanged(this.value)"
          autocomplete="off">
          <option class="bk" selected="true" value="All">All</option>
          <option class="bk" value="LAUSD Board Member">LAUSD Board Member</option>
          <option class="bk" value="City Attorney">City Attorney</option>
          <option class="bk" value="City Council Member">City Council Member</option>
          <option class="bk" value="City Controller">City Controller</option>
          <option class="bk" value="Mayor">Mayor</option>
        </select>
      </div>
    </div>

    <svg width="960" height="960"></svg>
    <script src="https://d3js.org/d3.v4.min.js" charset="utf-8"></script>
    <script src="https://d3js.org/topojson.v2.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-tip/0.7.1/d3-tip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.24.0/d3-legend.js"></script>

    <script>
      var mapsvg = d3.select("svg").on("click", stopped, true);
      var width = 960;
      var height = 960;
      var geoData;
      var contribData;
      var contribDataClone;

      var domain = [1000, 2500, 5000, 10000, 50000, 100000, 500000];
      var ramp = d3
        .scaleThreshold()
        .domain(domain)
        .range(d3.schemeBlues[8]);

      function getToolTip(mod = false) {
        var toolTip = d3
          .tip()
          .attr("class", "tooltip")
          .offset([80, -60]);

        if (mod) {
          return toolTip.html(function(d) {
            // if(d.properties.hasOwnProperty('sum2')) {
            return `Zip Code: ${
              d.properties.zipcode
            }<br>Sum: ${d3.format("($,")(d.properties.sum2.toFixed(0))}<br>Count: ${d.properties.count2}<br>Mean: ${d3.format("($,")(d.properties.mean2.toFixed(0))}`;
            // }
          });
        }
        return toolTip.html(function(d) {
          return `Zip Code: ${
            d.properties.zipcode
          }<br>Sum: ${d3.format("($,")(d.properties.sum.toFixed(0))}<br>Count: ${d.properties.count}<br>Mean: ${d3.format("($,")(d.properties.mean.toFixed(0))}`;
        });
      }

      var zoom = d3
        .zoom()
        // .translate([width / 2, height / 2])
        // .scale(scale0)
        // .scaleExtent([scale0, 10 * scale0])
        .scaleExtent([1, 8])
        .on("zoom", zoomed);

      function zoomed() {
        var currentTransform = d3.event.transform;
        mapsvg.style("stroke-width", 1.5 / currentTransform.k + "px");
        mapsvg.attr("transform", currentTransform);
      }

      function stopped() {
        if (d3.event.defaultPrevented) d3.event.stopPropagation();
      }

      function drawMap(w, h) {}

      let filterOptions = {
        cand: "All",
        period: "All",
        office: "All"
      };

      function changeData() {
        if (
          filterOptions.cand === "All" &&
          filterOptions.period === "All" &&
          filterOptions.office === "All"
        ) {
          render(contribData);
        } else {
          contribDataClone = JSON.parse(JSON.stringify(contribData));

          if (filterOptions.cand != "All") {
            contribDataClone = contribDataClone.filter(
              row => row.OC_NM_LST === filterOptions.cand
            );
          }
          if (filterOptions.period != "All") {
            contribDataClone = contribDataClone.filter(
              row => row.filing_period === filterOptions.period
            );
          }
          if (filterOptions.office != "All") {
            contribDataClone = contribDataClone.filter(
              row => row.OFC_DESC === filterOptions.office
            );
          }
          render(contribDataClone);
        }
      }

      function candOptionChanged(cand) {
        let last = cand.split(",")[0];

        if (filterOptions.cand != last) {
          filterOptions.cand = last;
          changeData();
        }
      }

      function fileOptionChanged(period) {
        if (filterOptions.period != period) {
          filterOptions.period = period;
          changeData();
        }
      }

      function officeOptionChanged(office) {
        if (filterOptions.office != office) {
          filterOptions.office = office;
          changeData();
        }
      }

      function render(data) {
        // Deep clone geojson data
        let geoclone = JSON.parse(JSON.stringify(geoData));

        var result = [];
        data.reduce(function(res, value) {
          if (!res[value.RPT_ZIP_CD]) {
            res[value.RPT_ZIP_CD] = {
              RPT_ZIP_CD: value.RPT_ZIP_CD,
              sum: 0,
              count: 0,
              mean: 0
            };
            result.push(res[value.RPT_ZIP_CD]);
          }
          res[value.RPT_ZIP_CD].sum += Number(value.TOT_CON_AMT);
          res[value.RPT_ZIP_CD].count += 1;
          res[value.RPT_ZIP_CD].mean =
            res[value.RPT_ZIP_CD].sum / res[value.RPT_ZIP_CD].count;
          return res;
        }, {});

        // Loop through each data value in the .csv file
        for (var i = 0; i < result.length; i++) {
          // Grab Zip Code
          var dataZip = result[i].RPT_ZIP_CD;

          // Grab total sum value
          var dataValue = result[i];

          // Find the corresponding state inside the GeoJSON
          for (var j = 0; j < geoclone.features.length; j++) {
            var jsonZip = geoclone.features[j].properties.zipcode;

            if (dataZip == jsonZip) {
              // Copy the data value into the JSON
              geoclone.features[j].properties.sum2 = dataValue.sum;
              geoclone.features[j].properties.count2 = dataValue.count;
              geoclone.features[j].properties.mean2 = dataValue.mean;

              // Stop looking through the JSON
              break;
            }
          }
        }

        let toolTip = getToolTip(true);

        mapsvg
          .selectAll("path")
          .data(geoclone.features)
          .style("fill", function(d) {
            if (d.properties.hasOwnProperty("sum2")) {
              // console.log(d.properties);
              return ramp(d.properties.sum2);
            }
            return "#ccc";
          })
          .call(toolTip)
          .on("mouseover", function(d) {
            if (d.properties.hasOwnProperty("sum2") && d.properties.sum2) {
              // toolTip.transition()
              //   .duration(200)
              //   .style("opacity", .9);
              toolTip.show(d);
            }
          })
          .on("mouseout", function(d, index) {
            // toolTip.transition()
            //   .duration(500)
            //   .style("opacity", 0);
            toolTip.hide(d);
          });
      }

      d3.json("Data Angels 2017 Contributions by Zip.topojson", function(error, data) {
        if (error) throw error;

        geoData = topojson.feature(
          data,
          data.objects["Data Angels 2017 Contributions by Zip"]
        );
        var chosenProjection = d3
          .geoAlbersUsa() //.geoMercator()
          .scale(1)
          // .translate([1300, 450])
          // .translate([width / 2, height / 2])
          // .translate([34.0000, -118.300])
          .fitSize([width, height], geoData);

        var path = d3.geoPath().projection(chosenProjection);

        let toolTip = getToolTip();

        // Legend
        var g = mapsvg
          .append("g")
          .attr("class", "legendThreshold")
          .attr("transform", "translate(5,30)");
        g.append("text")
          .attr("class", "caption")
          .attr("x", 0)
          .attr("y", -6)
          .text("Contribution Amount ($)");
        var legend = d3
          .legendColor()
          .labelFormat(d3.format(","))
          .labels(d3.legendHelpers.thresholdLabels)
          // .labels(function (d) { return labels[d.i]; })
          .shapePadding(4)
          // .useClass(true)
          .scale(ramp);

        mapsvg
          .selectAll("path")
          .data(geoData.features)
          .enter()
          .append("path")
          .attr("d", path)
          .style("fill", function(d) {
            if (d.properties.hasOwnProperty("sum") && d.properties.sum != 0) {
              return ramp(d.properties.sum);
            }
            return "#ccc";
          })
          .call(toolTip)
          .on("mouseover", function(d) {
            if (d.properties.hasOwnProperty("sum") && d.properties.sum) {
              // console.log(toolTip);
              // console.log(d3.select("#tooltip"));
              // toolTip.transition()
              //   .duration(200)
              //   .style("opacity", .9);
              toolTip.show(d);
            }
          })
          .on("mouseout", function(d, index) {
            // toolTip.transition()
            //   .duration(500)
            //   .style("opacity", 0);
            toolTip.hide(d);
          });

        mapsvg.select(".legendThreshold").call(legend);
      });

      d3.csv("2017 Contributions By Zip (clean).csv", function(error, data) {
        if (error) throw error;

        contribData = data;
        contribDataClone = JSON.parse(JSON.stringify(contribData));
      });
    </script>
  </body>
</html>
